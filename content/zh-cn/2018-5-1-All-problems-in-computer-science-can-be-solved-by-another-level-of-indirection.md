---
layout: post
title: "为什么“分层”给我们带来好处——论软件工程的分层概念"
Description: "计算机科学中的任何问题，都可以通过加上一层逻辑层来解决。-- David Wheeler"
date: 2018-05-01
tags: [架构]
comments: true
share: true
---
> All problems in computer science can be solved by another level of indirection -- David Wheeler
> 计算机科学中的任何问题，都可以通过加上一层逻辑层来解决。-- David Wheeler

### 总之，分层就是有好处

在计算机领域，“分层” 概念无处不在。比如 web 开发时的 MVC ，网络编程时的 OSI 参考模型和 TCP/IP 协议族。

但是为什么要进行分层呢？不同的书有不同的说法。

在《图解TCP/IP》这本书这样说：
> 在这一模型中，每个分层都接收它下一层所提供的特定服务，并且负责为自己的上一层提供特定的服务。上下层之间进行交互时所遵循的约定叫做“接口”。

在我看来，说了等于白说。:-P

而《企业应用架构模式》开篇第 1 章是这样说的：
> 在分解复杂的软件系统时，软件设计者用得最多的技术之一就是分层。

> 当用分层的观点来考虑系统时，可以将各个子系统想像成按照“多层蛋糕”的形式来组织，每一层都依托在其下层之上。在这种组织方式下，上层使用了下层定义的各种服务，而下层对上层一无所知。另外，每一层对自己的上层隐藏其下层的细节。

Marting Fowler在第 1 章后面，又举了一个表现层，领域层，数据源层的例子。但是个人认为依然没有把为什么要分层说透。

对于为什么要分层，我见过的大多数文章说的只是它带来的好处。比如下层修改实现，不影响上层使用；分离关注点等。但是为什么会带来这些好处？看似很傻的一个问题，其实很难回答。

### 两个例子帮助你认识“分层”
我们先通过两个例子给大家一些感性的认识。

#### 自动驾驶
用分层的思维来看开车这件事情是这样的：

| 分层   | 具体内容                           |
| ---- | ------------------------------ |
| 人的意图 | 前行，不上坡，右转弯                     |
| 人的操作 | 踩着油门，瞥一眼后视镜，方向盘打右              |
| 汽车运行 | 根据踩下油门的程度，发动机输出动力，而方向盘打右转动转向拉杆 |
| 发动机  | 进气，压缩，点燃，排气                    |
|  更底层省略....    |         更底层省略 .....                      |

因为有了分层，当我们要实现自动驾驶汽车时，要解决的就只是“人的操作”这一层的问题，而不需要实现“人的操作”以下所有的层，也就是不需要自己从头造汽车（不是绝对，但是绝对不需要从头造所有的部分）。

#### IoT 云云对接
总要举一个软件开发领域的例子吧。我们举一个 IoT 云云对接的例子。

当第三方云想控制 M云的空调时，系统的外观是这样的：

![image.png](/assets/images/292372-713edf09ffe20c0e.png)

如果我说用分层的方式，想必有人马上想要说 MVC blabla……。事实上，我不赞同这样。因为在我眼里，MVC 解决只是技术层面的问题。从技术角度分层的优先级比从业务角度分层的优先级低。换句话说，**分层可以从多个角度进行，不同的角度有不同的优先级**。

从业务角度如何分层呢？

![image.png](/assets/images/292372-518bc476e6c8787a.png)


我们可以将设备控制器分成：指令生成器和指令下发器。

我们也来说说这样设计带来的好处 :-P ：

1. 协议转换器的修改，不会影响设备控制器的逻辑。反之亦然。
2. 第三方云不需要知道如何组织空调的二进制，只需要表达自己的意图：空调20度。使用人类可读的json结构。
3. 不同云之间的对接互不影响。


#### 为什么分层能带来这些好处？
为什么分层能带来这些好处？刚毕业那会，我经常这样问自己。后来，经过一位高人的指导，再加上看过《面向对象分析与设计》之后，终于明白了：
> 开发软件本身是一件很复杂的事情（必须认识到这一点）。而我们人类大脑的能力是有限的，不可能同时处理太多的复杂性。我们可以通过将复杂性分解、抽象、分层，一次只需要处理一个部分复杂性，而不是所有。

所以，“分层”并不能让复杂性消失，而是让我们的大脑在能力范围内处理相对重要的层面的复杂性，而忽略那些不那么重要的细节。

比如开发一个HR系统，你的大脑应集中精力放在业务逻辑上，而不是操作系统如何与硬件打交道（并不是说操作系统原理不重要，只是在HR系统上不重要）。

![image.png](/assets/images/292372-93173bdbd6351048.png)


### 小结
软件开发所面对的复杂性超出了我们人类大脑一次性能处理的范围，而分层是一种手段，帮助我们人类只需要处理相对重要的层面的复杂性，而忽略相对不重要层面的复杂性。进而使我们以更低的成本达到目的。而好处只是副产品。

接下来的问题，如何进行分层呢？分层好坏的标准是什么？留给大家思考。

最后，强烈推介[《面向对象分析与设计》](https://book.douban.com/subject/11509672/)这本书。不要以为这又是一本只讲 UML 的书。
